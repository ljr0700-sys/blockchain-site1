/**
 * SPA 형식의 간단한 섹션 전환
 */
document.addEventListener("DOMContentLoaded", () => {
    const navLinks = document.querySelectorAll("#main-nav a");
    const sections = document.querySelectorAll(".page-section");

    navLinks.forEach(link => {
        link.addEventListener("click", (e) => {
            e.preventDefault();
            const targetId = link.getAttribute("data-target");

            // 메뉴 활성 상태 변경
            navLinks.forEach(l => l.classList.remove("active"));
            link.classList.add("active");

            // 섹션 표시 전환
            sections.forEach(sec => {
                if (sec.id === targetId) {
                    sec.classList.add("visible");
                } else {
                    sec.classList.remove("visible");
                }
            });
        });
    });

    // 폼 처리 및 해시 생성
    const assetForm = document.getElementById("asset-form");
    const resultCard = document.getElementById("register-result");

    let latestData = null; // 블록체인 섹션에서 사용할 최신 데이터

    if (assetForm) {
        assetForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const owner = document.getElementById("ownerName").value.trim();
            const type = document.getElementById("assetType").value.trim();
            const desc = document.getElementById("assetDesc").value.trim();

            if (!owner || !type) {
                alert("소유자 이름과 자산 종류는 필수입니다.");
                return;
            }

            const combined = `${owner}|${type}|${desc}|${new Date().toISOString()}`;

            try {
                const hashHex = await sha256(combined);
                const coinId = "EXP-" + hashHex.substring(0, 12).toUpperCase();

                // 결과 카드 표시
                document.getElementById("result-owner").textContent = owner;
                document.getElementById("result-type").textContent = type;
                document.getElementById("result-desc").textContent = desc || "(설명 없음)";
                document.getElementById("result-hash").textContent = hashHex;
                document.getElementById("result-coin").textContent = coinId;
                resultCard.classList.remove("hidden");

                // 최신 데이터 저장 (블록체인 섹션용)
                latestData = {
                    owner,
                    type,
                    desc: desc || "(설명 없음)",
                    hash: hashHex,
                    coinId
                };

                // 자동으로 블록체인 섹션에 반영
                updateBlockchainView(latestData);
            } catch (err) {
                console.error(err);
                alert("해시 생성 중 오류가 발생했습니다.");
            }
        });
    }

    // 블록체인 섹션
    const bcRefreshBtn = document.getElementById("bc-refresh");
    if (bcRefreshBtn) {
        bcRefreshBtn.addEventListener("click", () => {
            if (!latestData) {
                alert("아직 등록된 실험 데이터가 없습니다.");
                return;
            }
            updateBlockchainView(latestData);
            alert("최신 등록 정보를 불러왔습니다.");
        });
    }

    function updateBlockchainView(data) {
        if (!data) return;
        document.getElementById("bc-owner").textContent = data.owner;
        document.getElementById("bc-type").textContent = data.type;
        document.getElementById("bc-desc").textContent = data.desc;
        document.getElementById("bc-hash").textContent = data.hash;
        document.getElementById("bc-coin").textContent = data.coinId;
    }
});

/**
 * 브라우저 Web Crypto API 를 이용한 SHA-256 해시 함수
 * @param {string} message 
 * @returns {Promise<string>} 16진수 문자열
 */
async function sha256(message) {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    return hashHex;
}
